#!/bin/sh
#
# -a --alpha   the fraction of a supporting strain's sequence that actually supports the FR; alternatively, `1-alpha` is the fraction of inserted sequence
# -k --kappa   the maximum insertion length (measured in bp) that any supporting path may have
# -m --minsup  [1] minimum number of genome paths in order for a region to be considered frequent
# -z --minsize [1] minimum number of de Bruijn nodes that an FR must contain to be considered frequent
# -r --rc      flag to indicate whether the sequence (e.g. FASTA file) had its reverse complement appended

MEM=30

DOT="HDStudy+1kG.HTT.$MEM"
FASTA="HDStudy+1kG.HTT"
FRDIR="FR-$DOT.dot-$FASTA.fasta"

ALPHA=0.1
KAPPA=66
MINSUP=2
MINSIZE=1

PREFIX="FR-a$ALPHA-kp$KAPPA-sup$MINSUP-sz$MINSIZE"

ARGS="-1 -d HDStudy/$DOT.dot -f HDStudy/$FASTA.fasta --alpha $ALPHA --kappa $KAPPA --minsup $MINSUP --minsize $MINSIZE"

# run FRFinder
echo "#################### FRFinder ####################"
echo "FRFinder $ARGS"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar \
     org.ncgr.pangenomics.fr.FRFinder $ARGS

# build the files for the SVM
touch $FRDIR/$DOT.0.train

# training CASES
grep 116386.4_3071526_3247878 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 131922.4_3073057_3249428 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 158005.4_3072881_3249256 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 254853.4_3073559_3249927 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 281175.4_3072421_3248800 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 303296.4_3073189_3249571 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 314328.4_3073364_3249769 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 429266.4_3072818_3249168 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
# training CONTROLS
grep 123133.4_3073556_3249884 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 240256.4_3072818_3249106 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 291132.4_3073108_3249408 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 391824.4_3074017_3250259 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 412119.4_3072756_3248993 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 436024.4_3073051_3249386 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 509678.4_3073448_3249740 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train
grep 585500.4_3073458_3249830 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.train

# training CASES
sed s/116386.4_3071526_3247878/+1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/131922.4_3073057_3249428/+1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/158005.4_3072881_3249256/+1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/254853.4_3073559_3249927/+1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/281175.4_3072421_3248800/+1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/303296.4_3073189_3249571/+1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/314328.4_3073364_3249769/+1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/429266.4_3072818_3249168/+1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
# training CONTROLS
sed s/123133.4_3073556_3249884/-1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/240256.4_3072818_3249106/-1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/291132.4_3073108_3249408/-1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/391824.4_3074017_3250259/-1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/412119.4_3072756_3248993/-1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/436024.4_3073051_3249386/-1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train
sed s/509678.4_3073448_3249740/-1/ $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
sed s/585500.4_3073458_3249830/-1/ $FRDIR/$DOT.1.train > $FRDIR/$DOT.0.train

# replace commas with space and remove temp files
sed s/,/\ /g $FRDIR/$DOT.0.train > $FRDIR/$DOT.1.train
rm $FRDIR/$DOT.0.train
mv $FRDIR/$DOT.1.train $FRDIR/$DOT.train

touch $FRDIR/$DOT.0.test

# testing POSITIVES (based on genotype)
grep 430937.4_3073700_3250060 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 472802.4_3072881_3249234 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 611761.4_3073041_3249394 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 628863.4_3073298_3249649 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 642913.4_3072882_3249244 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 690847.4_3072753_3249103 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 690887.4_3073168_3249548 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
# testing NEGATIVES (genotype and not affected)
grep 692015.4_3072889_3249133 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep 714413.4_3073101_3249382 $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep HG00119_3071647_3247945  $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep HG00120_3071728_3248000  $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep HG00121_3071793_3248079  $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep HG00122_3071921_3248172  $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test
grep HG00123_3071737_3248040  $FRDIR/$PREFIX.csfr.txt >> $FRDIR/$DOT.0.test

# testing POSITIVES (based on genotype)
sed s/430937.4_3073700_3250060/+1/ $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
sed s/472802.4_3072881_3249234/+1/ $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test 
sed s/611761.4_3073041_3249394/+1/ $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test 
sed s/628863.4_3073298_3249649/+1/ $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test
sed s/642913.4_3072882_3249244/+1/ $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
sed s/690847.4_3072753_3249103/+1/ $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test
sed s/690887.4_3073168_3249548/+1/ $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
# testing NEGATIVES (genotype and not affected)
sed s/692015.4_3072889_3249133/-1/ $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test
sed s/714413.4_3073101_3249382/-1/ $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
sed s/HG00119_3071647_3247945/-1/  $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test
sed s/HG00120_3071728_3248000/-1/  $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
sed s/HG00121_3071793_3248079/-1/  $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test
sed s/HG00122_3071921_3248172/-1/  $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
sed s/HG00123_3071737_3248040/-1/  $FRDIR/$DOT.1.test > $FRDIR/$DOT.0.test

# replace commas with space and remove temp files
sed s/,/\ /g $FRDIR/$DOT.0.test > $FRDIR/$DOT.1.test
rm $FRDIR/$DOT.0.test
mv $FRDIR/$DOT.1.test  $FRDIR/$DOT.test

# combine train and test data for scaling
cat $FRDIR/$DOT.train $FRDIR/$DOT.test > $FRDIR/$DOT.both

# SVM files
RANGE="$FRDIR/$DOT.range"
TRAIN="$FRDIR/$DOT.train"
TEST="$FRDIR/$DOT.test"
BOTH="$FRDIR/$DOT.both"

TRAINSCALE="$TRAIN.scale"
TESTSCALE="$TEST.scale"
BOTHSCALE="$BOTH.scale"

GRIDOUT="$TRAIN.grid"
MODEL="$TRAIN.model"
PREDICT="$TEST.predict"

# delete the output from a previous run
rm -f $GRIDOUT
rm -f $MODEL
rm -f $PREDICT

# scale on combined data to get range
echo "-------------------------"
echo "SvmScaler -s $RANGE $BOTH"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.SvmScaler -s $RANGE $BOTH > $BOTHSCALE

# apply scale factors to train and test data
echo "-------------------------"
echo "SvmScaler -r $RANGE $TRAIN"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.SvmScaler -r $RANGE $TRAIN > $TRAINSCALE
echo "-------------------------"
echo "SvmScaler -r $RANGE $TEST"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.SvmScaler -r $RANGE $TEST > $TESTSCALE

# # run the parameter grid search on the scaled training data
# echo "-------- grid.py ------------"
# ./grid.py -gnuplot null -out null $TRAINSCALE > $GRIDOUT

# run GridSearcher on scaled training data
GRIDARGS="-log2c -5,15,2 -log2g 3,-15,-2 -n 5 $TRAINSCALE"
echo "-------------------------"
echo "GridSearcher $GRIDARGS"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.GridSearcher $GRIDARGS > $GRIDOUT
C=`tail -1 $GRIDOUT | awk '{ print $1; }'`
gamma=`tail -1 $GRIDOUT | awk '{ print $2; }'`
perc=`tail -1 $GRIDOUT | awk '{ print $3; }'`
echo "C=$C"
echo "gamma=$gamma"
echo "perc=$perc"

# train on the scaled training set with the above parameters to get the model
echo "-------------------------"
echo "SvmTrainer -c $C -g $gamma $TRAINSCALE $MODEL"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.SvmTrainer -c $C -g $gamma $TRAINSCALE $MODEL

# now run the predictor on the scaled test data with this model
echo "-------------------------"
echo "SvmPredictor $TESTSCALE $MODEL $PREDICT"
java -cp build/install/fr/lib/fr.jar:build/install/fr/lib/commons-cli-1.4.jar org.ncgr.svm.SvmPredictor $TESTSCALE $MODEL $PREDICT

# compare to what it should be
echo "-------------------------"
echo "TESTS:"
echo "1	1	1	1	1	1	1	-1	-1	-1	-1	-1	-1	-1"
echo "PREDICTIONS:"
cat $PREDICT
echo ""
