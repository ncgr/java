## plot a sort of heatmap of FRs versus nodes
## frs and nodes must already be loaded

source("plot.params.R")

plot.frs.or = function(xmin=0, xmax=0, ymin=0, ymax=0, xlegend="bottomleft", connect=TRUE) {

    ## represents infinity
    INFINITY = max(frs$OR[is.finite(frs$OR)])*2
    
    if (xmin==0) {
        xmin = min(as.numeric(rownames(nodes)))
    }
    if (xmax==0) {
        xmax = max(as.numeric(rownames(nodes)))
    }
    xlim = c(xmin,xmax)
    
    if (ymin==0) {
        ymin = min(frs$OR)
    }
    if (ymax==0 && is.finite(max(frs$OR))) {
        ymax = max(frs$OR)
    } else if (ymax==0) {
        ymax = INFINITY
    }
    ylim = c(ymin, ymax)

    xlab = "node"

    ylab = "odds ratio"

    reqNodes = as.numeric(strsplit(sub("\\[","",sub("\\]","",requiredNodes)), ",")[[1]])

    plot(xlim, rep(1.0,2), type="l", lty=2, col="lightgray",
         xlim=xlim, ylim=ylim,
         xlab=xlab, ylab=ylab)

    for (i in 1:nrow(frs)) {
        nodeString = frs$nodes[i]
        frNodes = as.numeric(strsplit(sub("\\[","",sub("\\]","",nodeString)), ",")[[1]])
        if (frs$p[i]<1e-2 && frs$OR[i]>1.0) {
            color = "darkred"
        } else if (frs$p[i]<1e-2 && frs$OR[i]<1.0) {
            color = "darkgreen"
        } else {
            color = "darkgray"
        }
        if (is.finite(frs$OR[i])) {
            points(frNodes, rep(frs$OR[i],length(frNodes)), col=color, pch=0)
            if (connect) {
                lines(frNodes, rep(frs$OR[i],length(frNodes)), col=color, lwd=1)
            }
            text(max(frNodes), frs$OR[i], paste(frs$case[i],"/",frs$ctrl[i]), col="black", pos=4, cex=0.7)
            lastOR = frs$OR[i]
        } else {
            points(frNodes, rep(INFINITY, length(frNodes)), col=color, pch=0)
            if (connect) {
                lines(frNodes, rep(INFINITY, length(frNodes)), col=color, lwd=1)
            }
            text(max(frNodes), INFINITY, paste(frs$case[i],"/",frs$ctrl[i]), col="black", pos=4, cex=0.7)
            lastOR = INFINITY
        }
        lastFRNodes = frNodes
    }
    
    points(lastFRNodes, rep(lastOR,length(lastFRNodes)), col=color, pch=15)
    text(lastFRNodes, rep(lastOR,length(lastFRNodes))+0.02*(ymax-ymin), lastFRNodes, col=color, cex=0.7)

    plot.params(x=xlegend)
}
